////老师对众发言模板 <li class="tch"> 	<span class="time">d.time</span> 	<b >d.name</b> 	<a href="javascript:void(0);">d.texts</a> </li>  //学生对众发言模板 <li class="stds"> 	<span class="time">09:45</span> 	<b >红玫瑰:</b> 	<a href="javascript:void(0);">老师讲的好好呀真让我大开眼界学到了好多知识呀</a> </li>  //管理员对众发言模板 <li class="admin"> 	<span class="time">09:45</span> 	<b >管理员:</b> 	<a href="javascript:void(0);">本课程有很重要的知识点望同学们采纳。</a> </li>  //学生提问模板 <li class="stdsAsk"> 	<i>提问</i> 	<b>红玫瑰:</b> 	<a href="javascript:void(0);">老师讲的好好呀真让我大开眼界学到了好多知识呀</a> </li>  //老师回答学生问题模板 <li class="tchAns"> 	<i>回答</i> 	<b>nickie老师:</b> 	<a href="javascript:void(0);">老师讲的好好呀真让我大开眼界学到了好多知识呀</a> 	<p> 		<span>【问题】</span> 		<b>红玫瑰:</b> 		<a href="javascript:void(0);">同学们要认真观看此视频还要有考试的。</a> 	</p> </li>  //问答展示区域模板 {{#for (var i = 0; i < d.length; i++) {}} <li> 	<div class="question"> 		<i class="iconfont">&#xe604;</i> 		<h6>【提问】</h6> 		<b>红玫瑰</b> 		<a href="javascript:void(0);">老师ps里面的快捷键视频里为啥没找到，是没有这一节吗？</a> 	</div> 	<div class="answer"> 		<i class="iconfont">&#xe605;</i> 		<h6>【最新回答】</h6> 		<b>nickie老师</b> 		<a href="javascript:void(0);">就在视频的结尾呢强调了一次可能你没看到。</a> 		<span class="time">时间：4天前</span> 	</div> </li> {{#}}} 课程目录模板 聊天室数据渲染方法
var tpl_tec=$('#tpl_tec').html();var tpl_stds=$('#tpl_stds').html();var tpl_admin=$('#tpl_admin').html();var tpl_tecAns=$('#tpl_tecAns').html();var tpl_adminTo=$('#tpl_adminTo').html();var tpl_tecTo=$('#tpl_teachTo').html();var tpl_studentTo=$('#tpl_studentTo').html();var tpl_stdsAsk=$('#tpl_stdsAsk').html();var tpl_tecAnsList=$('#tpl_tecAnsList').html();var messageList=$('#messageList');var teacherAnswerList=$('#teacherAnswerList');function tpl_tec(data){laytpl(tpl_tec).render(data,function(html){messageList.html(messageList.html()+html)})}function tpl_stds(data){laytpl(tpl_stds).render(data,function(html){messageList.html(messageList.html()+html)})}function tpl_admin(data){laytpl(tpl_admin).render(data,function(html){messageList.html(messageList.html()+html)})}function tpl_tecAns(data){laytpl(tpl_tecAns).render(data,function(html){messageList.html(messageList.html()+html)})}function tpl_tecAns(data){laytpl(tpl_tecAns).render(data,function(html){messageList.html(messageList.html()+html)})}function tpl_tecTo(data){laytpl(tpl_tecAns).render(data,function(html){messageList.html(messageList.html()+html)})}function tpl_adminTo(data){laytpl(tpl_tecAns).render(data,function(html){messageList.html(messageList.html()+html)})}function tpl_studentTo(data){laytpl(tpl_stdsAsk).render(data,function(html){messageList.html(messageList.html()+html)})}function tpl_tecAnsList(data){laytpl(tpl_tecAnsList).render(data,function(html){teacherAnswerList.html(teacherAnswerList.html()+html)})}function appendMessage(tpl,data,parent){var parent=parent||messageList;var gettpl=tpl;laytpl(gettpl).render(data,function(htmls){parent.html(parent.html()+htmls)})}var callObject=$('#callObject');var closeCharest=$('#closeCharest');closeCharest.on('click',function(){callObject.val(null);callObject.attr('data-userId',null)});messageList.on('click','b',function(){var name=$(this).attr('data_name');var userId=$(this).attr('data_userid');callObject.val(name);callObject.attr('data-userId',userId)});var ws=null;var tick_heartpac=null;var roomID=parseQueryString(window.location.href).courseId;var userid=null;var name=null;function onLogin(){$.ajax({type:"GET",url:"http://zjzx.test.com/zh-CN/Chat/GetUserConfig",dataType:"jsonp",data:{room:roomID,time:new Date().getTime()},jsonp:"callback",success:function(data){}})}function callback(json){if(json.code==1){ChatUrl=json.result.websocketurl;OpenWs();userid=json.result.userid;name=json.result.name;submitMessage()}}var messageListOut=$('#messageListOut');var answerWindow=$('#answerWindow');function scollToBottom(){var listHeight=messageList.height();var teacHeight=teacherAnswerList.height();if(listHeight>messageListOut.height()){messageListOut.css('marginRight','-15px');messageListOut.scrollTop(listHeight-chatWindow.height())}if(teacHeight>answerWindow.height()){answerWindow.scrollTop(teacHeight-answerWindow.height())}}function parseQueryString(str){var obj={};var reg=/\??(\w+)=(\w+)&?/g;var result;while((result=reg.exec(str))!=null){obj[result[1]]=result[2]}return obj}function timeStyle(time){time=new Date(time*1000);time=time.toTimeString();time=time.substring(0,5);return time}function OpenWs(){clearInterval(tick_heartpac);var fullUrl=url;if("WebSocket"in window){ws=new WebSocket(fullUrl)}else if("MozWebSocket"in window){ws=new MozWebSocket(fullUrl)}else{layer.msg('您的浏览器不支持聊天功能，请更换浏览器后再次尝试')}ws.onopen=function(){layer.msg('聊天室功能开启')};ws.onclose=function(){layer.msg('聊天室关闭')};ws.onerror=function(){layer.msg('网络错误，请刷新')};ws.onmessage=function(msg){var obj=JSON.parse(msg.data);var data=obj.data;for(var i=0;i<data.length;i+=1){data[i].content=JSON.parse(decodeURIComponent(data[i].content));data[i].from=JSON.parse(decodeURIComponent(data[i].from));data[i].to=JSON.parse(decodeURIComponent(data[i].to));data[i].time=timeStyle(data[i].timestamp)}switch(obj.code){case-1:layer.msg(obj.msg);break;case-2:layer.msg('网络错误，正在重新登录');OpenWs();break;case-3:layer.msg('当前聊天室即将关闭');break;case 5:appendMessage(tpl_stds,data);break;case 6:break;case 7:break;case 8:var userId=data[0].from.userId;if(userId.indexOf('S')>-1){appendMessage(tpl_adminTo,data)}else if(userId.indexOf('T')>-1){appendMessage(tpl_teachTo,data)}else{appendMessage(tpl_studentTo,data)}break;case 9:break;case 10:appendMessage(tpl_stdsAsk,data);break;case 11:appendMessage(tpl_tecAns,data);appendMessage(tpl_tecAnsList,data,teacherAnswerList);break;case 12:appendMessage(tpl_admin,data);break;case 13:break;case 14:appendMessage(tpl_tec,data);break}}}var yourMessage=$('#yourMessage');var submitChat=$('#submitChat');var submitAsk=$('#sumbitAsk');submitAsk.on('mouseover',function(){layer.tips('请输入内容','#sumbitAsk',{tips:[1,'#3595CC'],time:1000})});submitChat.on('mouseover',function(){layer.tips('请输入内容','#submitChat',{tips:[1,'#3595CC'],time:1000})});submitMessage();function submitMessage(){var msg=null;submitChat.on('click',function(){msg=yourMessage.val();if(msg){var charest=callObject.val();if(charest){toSelf(msg)}else{stdsSub(msg);}yourMessage.val('');}else{layer.tips('请输入内容','#yourMessage',{tips:[1,'#3595CC'],time:1000})}});submitAsk.on('click',function(){msg=yourMessage.val();if(msg){stdsAsk(msg);yourMessage.val('');}else{layer.tips('请输入内容','#yourMessage',{tips:[1,'#3595CC'],time:1000})}});}function toSelf(msg){var toId=callObject.attr("data-userId");var datas={act:"TOPERSONALSHOW",room:roomID,from:{userid:userid,name:name},touser:toId,content:{msg:msg}};datas.from=encodeURIComponent(JSON.stringify(datas.from));datas.content=encodeURIComponent(JSON.stringify(datas.content));ws.send(JSON.stringify(datas));callObject.val(null);callObject.attr('data-userId',null)}function adminSub(){var datas={act:"TOONLINE",room:roomID,from:{userid:userid,name:name},content:{msg:msg}};datas.from=encodeURIComponent(JSON.stringify(datas.from));datas.content=encodeURIComponent(JSON.stringify(datas.content));ws.send(JSON.stringify(datas))}function stdsSub(msg){var datas={act:"TOALL",room:roomID,from:{userid:userid,name:name},content:{msg:msg}};datas.from=encodeURIComponent(JSON.stringify(datas.from));datas.content=encodeURIComponent(JSON.stringify(datas.content));ws.send(JSON.stringify(datas))}function stdsAsk(){var datas={act:"PUTPROBLEM",room:roomID,from:{userid:"1213",name:"李四"},content:{question:msg}};datas.from=encodeURIComponent(JSON.stringify(datas.from));datas.content=encodeURIComponent(JSON.stringify(datas.content));ws.send(JSON.stringify(datas))}function tecAns(){var datas={act:"ANSWER",room:roomID,from:{userid:"1213",name:"李四"},to:{userid:"1213",name:"李四"},content:{question:quest,answer:msg}};datas.from=encodeURIComponent(JSON.stringify(datas.from));datas.content=encodeURIComponent(JSON.stringify(datas.content));ws.send(JSON.stringify(datas))}function tecSub(){var datas={act:"TEACHERTOALL",room:roomID,from:{userid:"1213",name:"李四"},content:{msg:msg}};datas.from=encodeURIComponent(JSON.stringify(datas.from));datas.content=encodeURIComponent(JSON.stringify(datas.content));ws.send(JSON.stringify(datas))}